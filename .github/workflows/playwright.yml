name: Playwright Tests
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v4
      with:
        node-version: lts/*

    - name: Install dependencies
      run: npm ci
    - name: Install Playwright Browsers
      run: npx playwright install --with-deps

    - name: Run Playwright tests (xvfb for headed browsers)
      run: |
        sudo apt-get update
        sudo apt-get install -y xvfb
        xvfb-run -a npx playwright test

    - name: List files
      if: always()
      run: ls
      working-directory: playwright-report

    - name: Create GitHub summary for Playwright results
      if: always()
      run: |
        echo "## Playwright Test Results" >> $GITHUB_STEP_SUMMARY
        if [ -f playwright-report/report.json ]; then
          cat > /tmp/playwright-summary.js <<'NODE'
        const fs = require('fs');
        const p = 'playwright-report/report.json';
        try {
          const data = JSON.parse(fs.readFileSync(p,'utf8'));
          const rows = [];
          (data.suites || []).forEach(suite => {
            (suite.specs || []).forEach(spec => {
              const specName = spec.file || spec.title || '';
              (spec.tests || []).forEach(test => {
                const testTitle = test.title || specName;
                (test.results || []).forEach(res => {
                  const platform = res.projectName || res.projectId || test.projectName || test.projectId || '';
                  const status = res.status || '';
                  const retries = (typeof res.retry === 'number') ? res.retry : 0;
                  let cause = '-';
                  if (res.errors && res.errors.length) {
                    cause = res.errors.map(e => (typeof e === 'string' ? e : (e.message || JSON.stringify(e)))).join(' | ');
                  }
                  cause = String(cause).replace(/\r?\n/g, ' ').replace(/\|/g, '\\|');
                  rows.push({ test: testTitle, platform, status, retries, cause });
                });
              });
            });
          });

          console.log('Teste | Plataforma | Status | Retries | Causa da falha');
          console.log('--- | --- | -- | -- | -- |');
          rows.forEach(r => console.log(`${r.test} | ${r.platform} | ${r.status} | ${r.retries} | ${r.cause}`));
        } catch (e) {
          console.error('Failed to parse report.json:', e && e.message ? e.message : e);
          process.exitCode = 1;
        }
        NODE
          node /tmp/playwright-summary.js >> $GITHUB_STEP_SUMMARY || true
        else
          echo 'playwright-report/report.json not found' >> $GITHUB_STEP_SUMMARY
        fi
      continue-on-error: true

    - uses: actions/upload-artifact@v4
      if: ${{ !cancelled() }}
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 30
